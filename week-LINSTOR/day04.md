# Day 4: æ•…éšœå¤„ç†ä¸é«˜å¯ç”¨

## ğŸ¯ å­¦ä¹ ç›®æ ‡
- **æŠ€èƒ½ç›®æ ‡**: æ·±å…¥ç†è§£åˆ†å¸ƒå¼å­˜å‚¨ä¸­æœ€å±é™©çš„é—®é¢˜â€”â€”â€œè£‚è„‘â€(Split-Brain)ï¼Œå¹¶æŒæ¡å…¶æˆå› ã€é¢„é˜²å’Œæ¢å¤æœºåˆ¶ã€‚
- **å®è·µç›®æ ‡**: èƒ½å¤Ÿæ¨¡æ‹ŸèŠ‚ç‚¹ç½‘ç»œæ•…éšœå’Œå®•æœºï¼Œå¹¶ç»ƒä¹ ä½¿ç”¨ LINSTOR è¿›è¡Œæ•…éšœåˆ‡æ¢å’Œè£‚è„‘æ¢å¤ã€‚
- **æ ¸å¿ƒæ¦‚å¿µ**: æŒæ¡ LINSTOR çš„è‡ªåŠ¨è£‚è„‘æ¢å¤ç­–ç•¥å’Œé«˜å¯ç”¨ Controller çš„é…ç½®æ€æƒ³ã€‚
- **æˆæœäº§å‡º**: ä¸€ä»½è¯¦ç»†çš„ DRBD è£‚è„‘é—®é¢˜åˆ†æåŠæ¢å¤æ‰‹å†Œï¼Œä¸€ä¸ªç»è¿‡æ•…éšœæ¼”ç»ƒã€æ›´åŠ å¥å£®çš„ LINSTOR é›†ç¾¤ã€‚

## ğŸ“š ç†è®ºåŸºç¡€ (50%)

### 1. è£‚è„‘ (Split-Brain) æ·±åº¦è§£æ
è£‚è„‘æ˜¯ä»»ä½•é«˜å¯ç”¨é›†ç¾¤ï¼ˆæ— è®ºæ˜¯æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯ DRBDï¼‰éƒ½éœ€è¦é¢å¯¹çš„ç»ˆæé—®é¢˜ã€‚

- **ä»€ä¹ˆæ˜¯è£‚è„‘ï¼Ÿ**
  åœ¨ä¸€ä¸ªåŒä¸»ï¼ˆæˆ–ä¸»ä»ï¼‰é›†ç¾¤ä¸­ï¼Œå½“ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„å¿ƒè·³ç½‘ç»œä¸­æ–­æ—¶ï¼Œå¦‚æœç¼ºä¹æœ‰æ•ˆçš„ä»²è£æœºåˆ¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯èƒ½è®¤ä¸ºå¯¹æ–¹å·²ç»æ­»äº¡ï¼Œä»è€Œéƒ½å°è¯•æ¥ç®¡æœåŠ¡ï¼Œå³éƒ½å°†è‡ªå·±æå‡ä¸º Primary è§’è‰²ã€‚æ­¤æ—¶ï¼Œé›†ç¾¤ä¸­å‡ºç°äº†ä¸¤ä¸ªâ€œå¤§è„‘â€ï¼Œå®ƒä»¬å„è‡ªç‹¬ç«‹åœ°æ¥å—å†™æ“ä½œã€‚å½“ç½‘ç»œæ¢å¤æ—¶ï¼Œè¿™ä¸¤ä¸ªâ€œå¤§è„‘â€ä¸Šçš„æ•°æ®å·²ç»å‘ç”Ÿäº†åˆ†æ­§ï¼Œæ— æ³•è‡ªåŠ¨åˆå¹¶ã€‚è¿™ç§æƒ…å†µå°±æ˜¯â€œè£‚è„‘â€ã€‚

- **DRBD ä¸­çš„è£‚è„‘åœºæ™¯**: 
  1. `node1` (Primary) å’Œ `node2` (Secondary) æ­£å¸¸è¿è¡Œã€‚
  2. ä¸¤è€…ä¹‹é—´çš„ç½‘ç»œè¿æ¥ä¸­æ–­ã€‚
  3. `node1` æ²¡æœ‰æ£€æµ‹åˆ°é—®é¢˜ï¼Œç»§ç»­ä½œä¸º Primary è¿è¡Œã€‚
  4. ä¸€ä¸ªå¤–éƒ¨çš„é›†ç¾¤ç®¡ç†å™¨ï¼ˆå¦‚ Pacemakerï¼‰æ£€æµ‹åˆ° `node1` â€œæ— å“åº”â€ï¼Œäºæ˜¯å†³å®šå°† `node2` æå‡ä¸º Primaryã€‚
  5. æ­¤æ—¶ï¼Œ`node1` å’Œ `node2` éƒ½æ˜¯ Primaryï¼Œéƒ½åœ¨æ¥å—å†™è¯·æ±‚ï¼Œæ•°æ®å¼€å§‹åˆ†å‰ã€‚

- **åæœ**: æ•°æ®æ°¸ä¹…æ€§ä¸ä¸€è‡´ï¼Œæ˜¯ç¾éš¾æ€§çš„ã€‚æ¢å¤çš„å”¯ä¸€æ–¹æ³•æ˜¯**é€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºâ€œèƒœåˆ©è€…â€ï¼Œå¹¶å®Œå…¨ä¸¢å¼ƒå¦ä¸€ä¸ªèŠ‚ç‚¹åœ¨æ­¤æœŸé—´çš„æ‰€æœ‰æ•°æ®æ›´æ”¹**ã€‚

### 2. é¢„é˜²å’Œå¤„ç†è£‚è„‘
é¢„é˜²æ°¸è¿œèƒœäºæ²»ç–—ã€‚

- **Quorum (ä»²è£æœºåˆ¶)**: åœ¨ä¸€ä¸ªå¤§äºä¸¤èŠ‚ç‚¹çš„é›†ç¾¤ä¸­ï¼Œå¯ä»¥è®¾ç½®â€œå¤šæ•°æ´¾â€è§„åˆ™ã€‚åªæœ‰å½“ä¸€ä¸ªèŠ‚ç‚¹èƒ½è”ç³»åˆ°é›†ç¾¤ä¸­è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹æ—¶ï¼Œå®ƒæ‰èƒ½æˆä¸º Primaryã€‚è¿™å¯ä»¥æœ‰æ•ˆé˜²æ­¢è£‚è„‘ã€‚å¯¹äºåŒèŠ‚ç‚¹é›†ç¾¤ï¼Œéœ€è¦ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ä»²è£è®¾å¤‡æˆ–èŠ‚ç‚¹ï¼ˆArbiterï¼‰ã€‚
- **STONITH (Shoot The Other Node In The Head)**: è¿™æ˜¯æœ€å¯é çš„è£‚è„‘é˜²æ­¢æœºåˆ¶ã€‚å½“é›†ç¾¤ç®¡ç†å™¨å†³å®šæå‡ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå®ƒä¼šå…ˆé€šè¿‡ä¸€ä¸ªç‹¬ç«‹çš„å¸¦å¤–é€šé“ï¼ˆå¦‚æœåŠ¡å™¨çš„ IPMI/BMC ç®¡ç†å£ï¼‰å»å¼ºåˆ¶å…³é—­æˆ–é‡å¯å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç¡®ä¿æ—§çš„ Primary ç»å¯¹â€œæ­»äº¡â€åï¼Œå†æå‡æ–°çš„ Primaryã€‚

- **LINSTOR/DRBD çš„è£‚è„‘è‡ªåŠ¨æ¢å¤ç­–ç•¥**: 
  DRBD è‡ªèº«å¯ä»¥æ£€æµ‹åˆ°è£‚è„‘çš„å‘ç”Ÿã€‚å½“ç½‘ç»œæ¢å¤æ—¶ï¼Œå®ƒä¼šæ‹’ç»è¿æ¥ï¼Œå¹¶å°†èµ„æºæ ‡è®°ä¸º `SplitBrain` çŠ¶æ€ã€‚LINSTOR æä¾›äº†å¤šç§è‡ªåŠ¨å¤„ç†ç­–ç•¥ï¼Œå¯ä»¥åœ¨ `resource-definition` ä¸­è®¾ç½®ï¼š
  - `discard-zero-changes`: å¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰æ”¶åˆ°ä»»ä½•æ–°çš„å†™æ“ä½œï¼Œè‡ªåŠ¨ä¸¢å¼ƒå®ƒã€‚
  - `discard-least-changes`: è‡ªåŠ¨ä¸¢å¼ƒå†™æ“ä½œè¾ƒå°‘çš„é‚£ä¸ªèŠ‚ç‚¹çš„æ•°æ®ã€‚
  - `discard-younger-primary` / `discard-older-primary`: æ ¹æ®æˆä¸º Primary çš„æ—¶é—´æ¥å†³å®šã€‚
  - **å¼ºçƒˆå»ºè®®**: ä»”ç»†é…ç½®è¿™äº›ç­–ç•¥ï¼Œå¦åˆ™é»˜è®¤æƒ…å†µä¸‹éœ€è¦æ‰‹åŠ¨å¹²é¢„ã€‚

### 3. LINSTOR Controller é«˜å¯ç”¨
LINSTOR Satellite æ˜¯æ— çŠ¶æ€çš„ï¼Œä½† Controller å­˜å‚¨äº†æ•´ä¸ªé›†ç¾¤çš„é…ç½®ï¼Œå®ƒæœ¬èº«å¯èƒ½æˆä¸ºå•ç‚¹æ•…éšœã€‚ç”Ÿäº§ç¯å¢ƒå¿…é¡»éƒ¨ç½²é«˜å¯ç”¨çš„ Controllerã€‚
- **å®ç°æ–¹å¼**: é€šå¸¸ä½¿ç”¨ Pacemaker + Corosync é›†ç¾¤è½¯ä»¶ï¼Œé…åˆä¸€ä¸ªæµ®åŠ¨ IP (Virtual IP) å’Œä¸€ä¸ªç”± DRBD ä¿æŠ¤çš„å…±äº«ç£ç›˜ã€‚è¿™ä¸ª DRBD ç£ç›˜ä¸“é—¨ç”¨äºå­˜æ”¾ LINSTOR Controller çš„æ•°æ®åº“ã€‚æ— è®º Controller åœ¨å“ªä¸ªç‰©ç†èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œå®ƒéƒ½é€šè¿‡æµ®åŠ¨ IP æä¾›æœåŠ¡ï¼Œå¹¶è¯»å†™åŒä¸€ä¸ª DRBD è®¾å¤‡ä¸Šçš„æ•°æ®ã€‚

## ğŸ› ï¸ å®è·µæ“ä½œ (40%)

### 1. æ¨¡æ‹Ÿç½‘ç»œæ•…éšœå¹¶åˆ¶é€ è£‚è„‘

```bash
# å‡è®¾ web-data èµ„æºåœ¨ node1 (Primary) å’Œ node2 (Secondary) ä¸Š

# 1. åœ¨ node1 ä¸Šï¼Œä½¿ç”¨ iptables é˜»æ­¢ä¸ node2 çš„ DRBD é€šä¿¡
sudo iptables -A INPUT -p tcp --dport 7789 -s 192.168.1.102 -j DROP

# 2. æŸ¥çœ‹çŠ¶æ€ï¼Œä¼šçœ‹åˆ° node1 ä¸Šçš„èµ„æºè¿›å…¥ WFConnection (ç­‰å¾…è¿æ¥) çŠ¶æ€
linstor resource list

# 3. åœ¨ node2 ä¸Šï¼Œå¼ºåˆ¶å°†å…¶æå‡ä¸º Primary (æ¨¡æ‹Ÿé›†ç¾¤ç®¡ç†å™¨çš„é”™è¯¯å†³ç­–)
sudo drbdadm primary web-data

# 4. æ­¤æ—¶ï¼Œnode1 å’Œ node2 éƒ½è®¤ä¸ºè‡ªå·±æ˜¯ Primaryã€‚å¯ä»¥å„è‡ªæŒ‚è½½å¹¶å†™å…¥ä¸åŒæ•°æ®
# åœ¨ node1 ä¸Š: sudo mount /dev/drbd/by-res/web-data/0 /mnt; echo "from node1" > /mnt/test.txt; sudo umount /mnt
# åœ¨ node2 ä¸Š: sudo mount /dev/drbd/by-res/web-data/0 /mnt; echo "from node2" > /mnt/test.txt; sudo umount /mnt

# 5. æ¢å¤ç½‘ç»œï¼Œç§»é™¤ iptables è§„åˆ™
sudo iptables -D INPUT -p tcp --dport 7789 -s 192.168.1.102 -j DROP

# 6. æŸ¥çœ‹çŠ¶æ€ï¼Œä½ ä¼šçœ‹åˆ°èµ„æºçŠ¶æ€å˜ä¸º SplitBrain
linstor resource list
```

### 2. æ‰‹åŠ¨æ¢å¤è£‚è„‘

```bash
# å†³ç­–ï¼šæˆ‘ä»¬é€‰æ‹©ä¿ç•™ node1 ä¸Šçš„æ•°æ®ï¼Œä¸¢å¼ƒ node2 ä¸Šçš„æ•°æ®ã€‚

# 1. åœ¨è¦è¢«ä¸¢å¼ƒçš„èŠ‚ç‚¹ (node2) ä¸Šï¼Œæ‰§è¡Œ discard å‘½ä»¤
sudo drbdadm disconnect web-data
sudo drbdadm secondary web-data
sudo drbdadm connect --discard-my-data web-data

# 2. åœ¨è¦ä¿ç•™çš„èŠ‚ç‚¹ (node1) ä¸Šï¼Œé‡æ–°è¿æ¥
sudo drbdadm disconnect web-data
sudo drbdadm connect web-data

# 3. è§‚å¯ŸçŠ¶æ€ï¼Œnode2 ä¼šå¼€å§‹ä½œä¸ºåŒæ­¥ç›®æ ‡ï¼Œä» node1 é‡æ–°åŒæ­¥æ•°æ®
watch -n1 cat /proc/drbd

# 4. éªŒè¯æ•°æ®ã€‚åŒæ­¥å®Œæˆåï¼Œåœ¨ node1 ä¸ŠæŒ‚è½½ï¼Œåº”è¯¥åªèƒ½çœ‹åˆ° "from node1" çš„å†…å®¹ã€‚
```

### 3. æ¨¡æ‹ŸèŠ‚ç‚¹å®•æœºä¸æ•…éšœåˆ‡æ¢

```bash
# å‡è®¾ node1 æ˜¯ Primary

# 1. æ¨¡æ‹Ÿ node1 å®•æœº
sudo systemctl stop linstor-satellite # æˆ–è€…ç›´æ¥é‡å¯è™šæ‹Ÿæœº

# 2. åœ¨ node2 ä¸Šï¼Œå°†èµ„æºæå‡ä¸º Primary
linstor resource promote web-data node2
# æˆ–è€…ä½¿ç”¨ drbdadm
# sudo drbdadm primary web-data

# 3. åœ¨ node2 ä¸ŠæŒ‚è½½å¹¶æä¾›æœåŠ¡
sudo mount /dev/drbd/by-res/web-data/0 /mnt
# ... æœåŠ¡æ­£å¸¸è¿è¡Œ ...

# 4. æ¢å¤ node1
sudo systemctl start linstor-satellite

# 5. LINSTOR/DRBD ä¼šè‡ªåŠ¨æ£€æµ‹åˆ° node1 å›å½’ï¼Œå¹¶å°†å…¶ä½œä¸º Secondary ä» node2 åŒæ­¥æ•°æ®ã€‚
```

## ğŸ’» Go ç¼–ç¨‹å®ç° (10%)

**ç›®æ ‡**: æ‰©å±•æ˜¨å¤©çš„ Go ç¨‹åºï¼Œè§£æ LINSTOR API è¿”å›çš„èµ„æºä¿¡æ¯ï¼Œå¹¶é«˜äº®æ˜¾ç¤ºçŠ¶æ€ä¸æ­£å¸¸çš„èµ„æºï¼ˆå¦‚ `SplitBrain`, `Inconsistent`ï¼‰ã€‚

```go
// ... (å¼•å…¥æ–°çš„ struct)
type ResourceState struct {
	NodeName string `json:"node_name"`
	State    string `json:"state"`
}

type ResourceInfo struct {
	Name   string          `json:"name"`
	States []ResourceState `json:"states"`
}

// ... (åœ¨ main å‡½æ•°ä¸­æ·»åŠ æ–°çš„ API è°ƒç”¨)
// resp, err := client.Get("http://.../v1/resources")
// ... (è§£æ JSON åˆ° []ResourceInfo)

fmt.Println("--- LINSTOR Resources ---")
for _, res := range resources {
	fmt.Printf("Resource: %s\n", res.Name)
	for _, state := range res.States {
		isHealthy := state.State == "UpToDate"
		if !isHealthy {
			fmt.Printf("  - Node: %-10s State: \033[91m%s\033[0m\n", state.NodeName, state.State) // æ ‡çº¢
		} else {
			fmt.Printf("  - Node: %-10s State: %s\n", state.NodeName, state.State)
		}
	}
}
```

## ğŸ” æ•…éšœæ’æŸ¥ä¸ä¼˜åŒ–
- **æ— æ³•è‡ªåŠ¨æ¢å¤è£‚è„‘**: æ£€æŸ¥èµ„æºå®šä¹‰ä¸­æ˜¯å¦é…ç½®äº†è‡ªåŠ¨æ¢å¤ç­–ç•¥ã€‚`linstor resource-definition get-property <res_name> DrbdOptions/auto-recover-target-role`ã€‚
- **ä¼˜åŒ–**: åœ¨å…³é”®ä¸šåŠ¡ä¸­ï¼Œæ°¸è¿œä¸è¦ä¾èµ–æ‰‹åŠ¨çš„æ•…éšœåˆ‡æ¢ã€‚å¿…é¡»ä½¿ç”¨åƒ Pacemaker è¿™æ ·çš„æˆç†Ÿçš„é›†ç¾¤ç®¡ç†å™¨æ¥è‡ªåŠ¨åŒ–æ•…éšœæ£€æµ‹å’Œèµ„æºè½¬ç§»ï¼Œå¹¶é…åˆ STONITH æœºåˆ¶æ¥å½»åº•æœç»è£‚è„‘é£é™©ã€‚

## ğŸ  è¯¾åä½œä¸š
- **æ·±å…¥ç ”ç©¶**: è¯¦ç»†é˜…è¯» LINSTOR ç”¨æˆ·æ‰‹å†Œä¸­å…³äºâ€œQuorumâ€å’Œè£‚è„‘æ¢å¤ç­–ç•¥çš„æ‰€æœ‰é€‰é¡¹ï¼Œå¹¶ç†è§£æ¯ä¸ªé€‰é¡¹çš„é€‚ç”¨åœºæ™¯ã€‚
- **é«˜å¯ç”¨ Controller**: ç”»å‡ºä¸€å¼  LINSTOR é«˜å¯ç”¨ Controller çš„æ¶æ„å›¾ï¼ŒåŒ…å« Pacemakerã€Corosyncã€Virtual IP å’Œ DRBD ç­‰ç»„ä»¶ï¼Œå¹¶æè¿°å…¶å·¥ä½œæµç¨‹ã€‚
