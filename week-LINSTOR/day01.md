# Day 1: DRBD æ ¸å¿ƒåŽŸç†ä¸Žæ‰‹åŠ¨é…ç½®

## ðŸŽ¯ å­¦ä¹ ç›®æ ‡
- **æŠ€èƒ½ç›®æ ‡**: æ·±å…¥ç†è§£ DRBD ä½œä¸ºç½‘ç»œRAID-1çš„å®žæ—¶å—è®¾å¤‡å¤åˆ¶åŽŸç†ã€‚
- **å®žè·µç›®æ ‡**: èƒ½å¤Ÿç‹¬ç«‹ã€æ‰‹åŠ¨åœ°é…ç½®ä¸€ä¸ªåŒèŠ‚ç‚¹çš„ DRBD èµ„æºï¼Œå¹¶å®Œæˆä¸»ä»Žåˆ‡æ¢ã€‚
- **è¿ç»´èƒ½åŠ›**: å­¦ä¼šä½¿ç”¨ `drbdadm` å’Œ `/proc/drbd` å¯¹ DRBD èµ„æºè¿›è¡ŒçŠ¶æ€ç›‘æŽ§å’ŒåŸºç¡€ç®¡ç†ã€‚
- **æˆæžœäº§å‡º**: ä¸€ä¸ªæ­£å¸¸å·¥ä½œçš„åŒèŠ‚ç‚¹ DRBD é›†ç¾¤ï¼Œä¸€ä»½è¯¦ç»†çš„ DRBD åŒæ­¥åè®® (A, B, C) å¯¹æ¯”åˆ†æžç¬”è®°ã€‚

## ðŸ“š ç†è®ºåŸºç¡€ (40%)

### 1. DRBD (Distributed Replicated Block Device) æ·±åº¦è§£æž
DRBD æ˜¯ä¸€ç§è½¯ä»¶å®šä¹‰çš„å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œç”¨äºŽåœ¨ç½‘ç»œä¸Šçš„å¤šå°æœåŠ¡å™¨ä¹‹é—´å®žçŽ°å—è®¾å¤‡çš„å®žæ—¶ã€åŒæ­¥å¤åˆ¶ã€‚å®ƒå·¥ä½œåœ¨ Linux å†…æ ¸çš„å—è®¾å¤‡å±‚ï¼Œè™šæ‹Ÿå‡ºä¸€ä¸ª `/dev/drbdX` è®¾å¤‡ã€‚å¯¹è¿™ä¸ªè®¾å¤‡çš„ä»»ä½•å†™å…¥æ“ä½œï¼Œéƒ½ä¼šè¢« DRBD é©±åŠ¨æ‹¦æˆªï¼Œä¸€ä»½å†™å…¥æœ¬åœ°ç£ç›˜ï¼Œå¦ä¸€ä»½é€šè¿‡ç½‘ç»œå‘é€ç»™å¯¹ç«¯èŠ‚ç‚¹ï¼Œå†ç”±å¯¹ç«¯èŠ‚ç‚¹çš„ DRBD é©±åŠ¨å†™å…¥å…¶æœ¬åœ°ç£ç›˜ã€‚

- **ç½‘ç»œ RAID-1**: è¿™æ˜¯ç†è§£ DRBD æœ€ç®€å•çš„æ–¹å¼ã€‚ä¼ ç»Ÿçš„ RAID-1 åœ¨ä¸€å—ä¸»æœºçš„ä¸¤å—ç¡¬ç›˜é—´é•œåƒæ•°æ®ï¼Œè€Œ DRBD åœ¨ä¸¤å°ä¸»æœºä¹‹é—´é€šè¿‡ç½‘ç»œé•œåƒæ•°æ®ã€‚
- **ä¸»/ä»Ž (Primary/Secondary) è§’è‰²**: ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä»»ä½•æ—¶å€™åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹èƒ½ä»¥ Primary è§’è‰²æŒ‚è½½å¹¶è¯»å†™ DRBD è®¾å¤‡ã€‚å¦ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»å¤„äºŽ Secondary è§’è‰²ï¼Œå®ƒæŽ¥æ”¶æ‰€æœ‰æ›´æ–°ï¼Œä½†ä¸èƒ½ç›´æŽ¥è¢«ä¸Šå±‚åº”ç”¨è®¿é—®ã€‚
- **å…ƒæ•°æ® (Metadata)**: DRBD åœ¨åº•å±‚ç‰©ç†è®¾å¤‡çš„æœ«å°¾ä¿ç•™ä¸€å°å—åŒºåŸŸæ¥å­˜å‚¨è‡ªå·±çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬é…ç½®ä¿¡æ¯ã€æ´»åŠ¨æ—¥å¿—ã€ä½å›¾ç­‰ï¼Œç”¨äºŽè·Ÿè¸ªæ•°æ®åŒæ­¥çŠ¶æ€å’Œå¿«é€Ÿæ¢å¤ã€‚

### 2. DRBD åŒæ­¥åè®®
DRBD æä¾›äº†ä¸‰ç§ä¸åŒçš„åŒæ­¥åè®®ï¼Œç”¨äºŽåœ¨æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§ä¹‹é—´åšæƒè¡¡ã€‚

- **Protocol C (åŒæ­¥å¤åˆ¶)**: 
  - **æµç¨‹**: åº”ç”¨ç¨‹åºçš„å†™æ“ä½œ -> æœ¬åœ°ç£ç›˜å†™å…¥å®Œæˆ -> æ•°æ®åŒ…é€šè¿‡ç½‘ç»œå‘é€ -> **å¯¹ç«¯èŠ‚ç‚¹ç¡®è®¤å†™å…¥å®Œæˆ** -> åº”ç”¨ç¨‹åºæ”¶åˆ°å†™æˆåŠŸçš„å›žåº”ã€‚
  - **ä¼˜ç‚¹**: **é›¶æ•°æ®ä¸¢å¤± (RPO=0)**ã€‚ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œå¯ä»¥ç¡®ä¿¡æ‰€æœ‰å·²ç¡®è®¤çš„å†™æ“ä½œéƒ½å·²åŒæ­¥åˆ°ä»ŽèŠ‚ç‚¹ã€‚
  - **ç¼ºç‚¹**: æ€§èƒ½æœ€ä½Žï¼Œå› ä¸ºæ¯æ¬¡å†™æ“ä½œçš„å»¶è¿Ÿéƒ½åŒ…å«äº†ç½‘ç»œå¾€è¿”æ—¶é—´å’Œå¯¹ç«¯ç£ç›˜å†™å…¥æ—¶é—´ã€‚
  - **é€‚ç”¨åœºæ™¯**: æ•°æ®åº“ã€äº¤æ˜“ç³»ç»Ÿç­‰å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚æœ€é«˜çš„åœºæ™¯ã€‚

- **Protocol B (åŠåŒæ­¥å¤åˆ¶)**: 
  - **æµç¨‹**: åº”ç”¨ç¨‹åºçš„å†™æ“ä½œ -> æœ¬åœ°ç£ç›˜å†™å…¥å®Œæˆ -> æ•°æ®åŒ…é€šè¿‡ç½‘ç»œå‘é€ -> **å¯¹ç«¯èŠ‚ç‚¹ç¡®è®¤å·²æŽ¥æ”¶åˆ°æ•°æ®åŒ…** -> åº”ç”¨ç¨‹åºæ”¶åˆ°å†™æˆåŠŸçš„å›žåº”ã€‚
  - **ä¼˜ç‚¹**: æ€§èƒ½ä¼˜äºŽ Protocol Cï¼Œå› ä¸ºå®ƒä¸ç­‰å¾…å¯¹ç«¯ç£ç›˜å†™å…¥å®Œæˆã€‚
  - **ç¼ºç‚¹**: ä¸»èŠ‚ç‚¹çªç„¶å®•æœºæ—¶ï¼Œæœ€åŽä¸€æ¬¡ä¼ è¾“ä¸­çš„æ•°æ®å¯èƒ½åœ¨ä»ŽèŠ‚ç‚¹ä¸Šè¿˜æœªå†™å…¥ç£ç›˜ï¼Œå­˜åœ¨å¾®å°çš„æ•°æ®ä¸¢å¤±é£Žé™©ã€‚
  - **é€‚ç”¨åœºæ™¯**: éœ€è¦è¾ƒé«˜æ€§èƒ½ï¼Œä½†èƒ½å®¹å¿æžå°‘é‡æ•°æ®ä¸¢å¤±çš„åœºæ™¯ã€‚

- **Protocol A (å¼‚æ­¥å¤åˆ¶)**: 
  - **æµç¨‹**: åº”ç”¨ç¨‹åºçš„å†™æ“ä½œ -> **æœ¬åœ°ç£ç›˜å†™å…¥å®Œæˆ** -> åº”ç”¨ç¨‹åºæ”¶åˆ°å†™æˆåŠŸçš„å›žåº”ã€‚æ•°æ®åŒ…åœ¨åŽå°å¼‚æ­¥å‘é€ç»™å¯¹ç«¯èŠ‚ç‚¹ã€‚
  - **ä¼˜ç‚¹**: **æ€§èƒ½æœ€é«˜**ï¼Œå‡ ä¹Žä¸å—ç½‘ç»œå»¶è¿Ÿå½±å“ã€‚
  - **ç¼ºç‚¹**: æ•°æ®ä¸¢å¤±é£Žé™©æœ€å¤§ã€‚å¦‚æžœä¸»èŠ‚ç‚¹å®•æœºï¼Œæ‰€æœ‰åœ¨ç½‘ç»œç¼“å†²åŒºä¸­è¿˜æœªå‘é€çš„æ•°æ®éƒ½ä¼šä¸¢å¤±ã€‚
  - **é€‚ç”¨åœºæ™¯**: å¹¿åŸŸç½‘ (WAN) ç¾å¤‡ã€å¯¹æ€§èƒ½è¦æ±‚æžé«˜ä½†å¯¹æ•°æ®åŒæ­¥è¦æ±‚ä¸é«˜çš„åœºæ™¯ã€‚

## ðŸ› ï¸ å®žè·µæ“ä½œ (50%)

### çŽ¯å¢ƒå‡†å¤‡
- ä¸¤å°è™šæ‹Ÿæœº: `node1` (192.168.1.101), `node2` (192.168.1.102)
- æ¯å°æœºå™¨æ·»åŠ ä¸€å—åŒæ ·å¤§å°çš„è£¸ç›˜ï¼Œå¦‚ `/dev/sdb` (ä¾‹å¦‚ 10GB)ã€‚ç¡®ä¿å®ƒæœªè¢«åˆ†åŒºå’Œä½¿ç”¨ã€‚
- ç¡®ä¿ä¸¤å°æœºå™¨ä¸»æœºåé…ç½®æ­£ç¡®ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ä¸»æœºåäº’ç›¸ ping é€šã€‚

### 1. å®‰è£…ä¸Žé…ç½®

```bash
# åœ¨ node1 å’Œ node2 ä¸ŠåŒæ—¶æ‰§è¡Œ

# 1. å®‰è£… DRBD å·¥å…·
sudo apt-get update
sudo apt-get install -y drbd-utils

# 2. åŠ è½½ DRBD å†…æ ¸æ¨¡å—
sudo modprobe drbd

# 3. åˆ›å»º DRBD èµ„æºé…ç½®æ–‡ä»¶ã€‚æ–‡ä»¶åå¿…é¡»æ˜¯ .res ç»“å°¾
# åœ¨ /etc/drbd.d/r0.res æ–‡ä»¶ä¸­å†™å…¥ä»¥ä¸‹å†…å®¹ (ä¸¤å°æœºå™¨é…ç½®ç›¸åŒ)
sudo tee /etc/drbd.d/r0.res > /dev/null <<'EOF'
resource r0 {
  protocol C; # ä½¿ç”¨æœ€å®‰å…¨çš„åŒæ­¥åè®®

  on node1 {
    device    /dev/drbd0;      # DRBD è™šæ‹Ÿè®¾å¤‡å
    disk      /dev/sdb;        # åº•å±‚ç‰©ç†è®¾å¤‡
    address   192.168.1.101:7789; # æœ¬æœºç›‘å¬åœ°å€å’Œç«¯å£
    meta-disk internal;        # å…ƒæ•°æ®å­˜å‚¨åœ¨ç‰©ç†è®¾å¤‡å†…éƒ¨
  }

  on node2 {
    device    /dev/drbd0;
    disk      /dev/sdb;
    address   192.168.1.102:7789;
    meta-disk internal;
  }
}
EOF
```

### 2. åˆå§‹åŒ–ä¸Žå¯åŠ¨

```bash
# åœ¨ node1 å’Œ node2 ä¸ŠåŒæ—¶æ‰§è¡Œ

# 1. åˆå§‹åŒ–å…ƒæ•°æ®åŒºåŸŸã€‚è¿™ä¼šå‘åº•å±‚è®¾å¤‡å†™å…¥ DRBD å…ƒæ•°æ®ã€‚
# è¿™ä¸ªæ“ä½œåªéœ€è¦åœ¨ç¬¬ä¸€æ¬¡åˆ›å»ºèµ„æºæ—¶æ‰§è¡Œä¸€æ¬¡ã€‚
sudo drbdadm create-md r0

# 2. å¯åŠ¨ DRBD èµ„æºã€‚è¿™ä¼šä½¿ DRBD é©±åŠ¨å…³è”ä¸Šå±‚å’Œä¸‹å±‚è®¾å¤‡ã€‚
sudo drbdadm up r0

# 3. æŸ¥çœ‹å½“å‰çŠ¶æ€ã€‚æ­¤æ—¶ä¸¤ä¸ªèŠ‚ç‚¹éƒ½åº”è¯¥æ˜¯ Secondary/Secondary, Inconsistent/Inconsistent
sudo drbdadm status r0
# æˆ–è€…æ›´è¯¦ç»†çš„
cat /proc/drbd
```

### 3. é¦–æ¬¡åŒæ­¥

```bash
# åªåœ¨ node1 ä¸Šæ‰§è¡Œ

# 1. å°† node1 å¼ºåˆ¶è®¾ç½®ä¸ºä¸»èŠ‚ç‚¹ã€‚--force é€‰é¡¹åªåœ¨é¦–æ¬¡åŒæ­¥æ—¶éœ€è¦ï¼Œ
# å®ƒå‘Šè¯‰ DRBD â€œä»¥æˆ‘ä¸ºå‡†ï¼Œè¦†ç›–å¯¹ç«¯çš„æ•°æ®â€ã€‚
sudo drbdadm primary --force r0

# 2. ç›‘æŽ§åŒæ­¥çŠ¶æ€ã€‚ä½ ä¼šçœ‹åˆ°åŒæ­¥è¿›åº¦ã€‚
watch -n1 cat /proc/drbd
# ç­‰å¾…ç›´åˆ°çŠ¶æ€å˜ä¸º Primary/Secondary, UpToDate/UpToDate
```

### 4. ä½¿ç”¨ DRBD è®¾å¤‡

```bash
# åªåœ¨ node1 (å½“å‰çš„ä¸»èŠ‚ç‚¹) ä¸Šæ‰§è¡Œ

# 1. åœ¨ DRBD è®¾å¤‡ä¸Šåˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ
sudo mkfs.ext4 /dev/drbd0

# 2. æŒ‚è½½å¹¶ä½¿ç”¨
sudo mount /dev/drbd0 /mnt
df -hT /mnt

# 3. å†™å…¥æµ‹è¯•æ•°æ®
sudo touch /mnt/testfile1.txt
ls /mnt

# 4. ä½¿ç”¨å®Œæ¯•åŽå¸è½½
sudo umount /mnt
```

## ðŸ” æ•…éšœæŽ’æŸ¥ä¸Žä¼˜åŒ–
- **`drbdadm up` å¤±è´¥**: 
  - **æŽ’æŸ¥**: æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº† 7789 ç«¯å£çš„é€šä¿¡ã€‚æ£€æŸ¥ `/etc/drbd.d/r0.res` ä¸­çš„ IP åœ°å€å’Œä¸»æœºåæ˜¯å¦æ­£ç¡®ã€‚
- **èŠ‚ç‚¹æ— æ³•è¿žæŽ¥ (WFConnection)**: 
  - **æŽ’æŸ¥**: æ£€æŸ¥ç½‘ç»œè¿žé€šæ€§ã€‚ç¡®è®¤å¯¹ç«¯èŠ‚ç‚¹çš„ `drbd` æœåŠ¡æ­£åœ¨è¿è¡Œã€‚
- **ä¼˜åŒ–**: åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­ï¼ŒDRBD çš„ç½‘ç»œæµé‡åº”è¯¥è·‘åœ¨ä¸“ç”¨çš„é«˜é€Ÿã€ä½Žå»¶è¿Ÿç½‘ç»œé“¾è·¯ä¸Šï¼ˆä¾‹å¦‚ä¸¤å°æœåŠ¡å™¨ç½‘å¡ç›´è¿žï¼‰ï¼Œä»¥æœ€å°åŒ–å¯¹ä¸šåŠ¡ç½‘ç»œçš„å½±å“å’Œå¤åˆ¶å»¶è¿Ÿã€‚

## ðŸ“ å®žæˆ˜é¡¹ç›®
- **ä¸»/ä»Žè§’è‰²åˆ‡æ¢ (Failover)**: 
  1. åœ¨å½“å‰ä¸»èŠ‚ç‚¹ `node1` ä¸Šï¼Œå¸è½½æ–‡ä»¶ç³»ç»Ÿ `sudo umount /mnt`ã€‚
  2. å°† `node1` é™çº§ä¸ºä»ŽèŠ‚ç‚¹: `sudo drbdadm secondary r0`ã€‚
  3. åœ¨ `node2` ä¸Šï¼Œå°† `node2` å‡çº§ä¸ºä¸»èŠ‚ç‚¹: `sudo drbdadm primary r0`ã€‚
  4. åœ¨ `node2` ä¸Šï¼ŒæŒ‚è½½è®¾å¤‡: `sudo mount /dev/drbd0 /mnt`ã€‚
  5. éªŒè¯ä¹‹å‰åœ¨ `node1` ä¸Šåˆ›å»ºçš„æ–‡ä»¶ `testfile1.txt` æ˜¯å¦å­˜åœ¨ã€‚

## ðŸ  è¯¾åŽä½œä¸š
- **æ·±å…¥ç ”ç©¶**: è¯¦ç»†é˜…è¯» `drbd.conf` çš„ man pageï¼Œç‰¹åˆ«æ˜¯ `net` å’Œ `disk` é…ç½®å—ä¸­çš„é«˜çº§é€‰é¡¹ï¼Œå¦‚ `timeout`, `c-plan-ahead`, `on-io-error` ç­‰ï¼Œå¹¶ç†è§£å®ƒä»¬çš„å«ä¹‰ã€‚
- **åè®®å¯¹æ¯”**: ç¼–è¾‘ `r0.res` æ–‡ä»¶ï¼Œå°† `protocol C` æ”¹ä¸º `protocol A`ï¼Œé‡å¯ DRBD æœåŠ¡åŽï¼Œä½¿ç”¨ `fio` æˆ– `dd` æµ‹è¯•å†™æ€§èƒ½ï¼Œç›´è§‚æ„Ÿå—ä¸åŒåè®®å¸¦æ¥çš„æ€§èƒ½å·®å¼‚ã€‚
